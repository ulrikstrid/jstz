function r(e){return"string"==typeof e}function p(n,e){return Array.isArray(e)&&e.reduce((e,r)=>e&&n(r),!0)}function n(e){return"number"==typeof e&&Number.isInteger(e)}function t(e){try{return r(e.to)&&n(e.token_id)&&Number.isInteger(e.amount)}catch{return!1}}function h(e){try{return r(e.from)&&p(t,e.transfers)}catch{return!1}}function _(e){try{return("add_operator"===e.operation||"remove_operator"===e.operation)&&r(e.owner)&&r(e.operator)&&n(e.token_id)}catch{return!1}}function o(e){try{return r(e.owner)&&n(e.token_id)}catch{return!1}}function w(e){try{return r(e.callback)&&p(o,e.requests)}catch{return!1}}function e(e){try{return o(e.request)&&Number.isInteger(e.balance)}catch{return!1}}function m(e){try{return console.info(e),n(e.token_id)&&r(e.owner)&&Number.isInteger(e.amount)}catch{return console.error(error),!1}}function a(e){return"token/"+e}function s(e){Kv.set(a(e),!0)}function c(e){if(!Kv.get(a(e)))throw"FA2_TOKEN_UNDEFINED"}function u(e,r){return`balance/${e}/`+r}function i(e,r){return Kv.get(u(e,r))||0}function f(e,r,n){if(n<0)throw"FA2_INSUFFICIENT_BALANCE";Kv.set(u(e,r),n)}function l(e,r,n){f(e,r,i(e,r)+n)}function d(e,r,n,t){l(e,n,-t),l(r,n,t)}function v(e,r,n){return`owner/${e}/${r}/`+n}function k(e,r,n){Kv.set(v(e,r,n),!0)}function y(e,r,n){Kv.delete(v(e,r,n))}function b(e,r,n){if(e!==r&&!Kv.get(v(e,r,n)))throw"FA2_NOT_OPERATOR"}function g(e,r){if(e!==r)throw"FA2_NOT_OWNER"}function N(e,r,n){c(n.token_id),b(e,r,n.token_id),d(e,n.to,n.token_id,n.amount)}function R(r,n){n.transfers.forEach(e=>N(n.from,r,e))}function O(e,r){switch(r.operation){case"add_operator":g(r.owner,e),k(r.owner,r.operator,r.token_id);break;case"remove_operator":b(r.owner,e,r.token_id),y(r.owner,r.operator,r.token_id)}}function T(e,n){let t={},o=[];return e.forEach(e=>{var r=JSON.stringify(e);t[r]||(t[r]=!0,o.push(n(e)),n(e))}),o}function E(e){return{request:e,balance:i(e.owner,e.token_id)}}async function I(e){var r=T(e.requests,E),e=new Request("tezos://"+e.callback,{method:"POST",body:JSON.stringify(r)});Contract.call(e);return r}function q(e){s(e.token_id),l(e.owner,e.token_id,e.amount)}async function P(r){var e,n,t,o,a,s,c=new URL(r.url),u=c.pathname;console.log("hello from fa2 contract");try{switch(u){case"/balance_of":return"GET"===r.method?w(e={requests:JSON.parse(TextEncoder.atob(c.searchParams.get("requests"))),callback:c.searchParams.get("callback")})?(n=await I(e),Response.json(n)):(console.error("Invalid parameters",e),Response.error()):(t="/balance_of is a GET request",console.error(t),new Response(t,{status:500}));case"/transfer":if("POST"!==r.method)return o="/transfer is a POST request",console.error(o),new Response(o,{status:500});var i=await r.json();if(!h(i))return console.error("Invalid parameters",i),Response.error();R(r.headers.get("Referer"),i);case"/mint_new":if("POST"!==r.method)return a="/mint_new is a POST request",console.error(a),new Response(a,{status:500});var f=await r.json();if(!p(m,f))return console.error("Invalid parameters",JSON.stringify(f)),Response.error();f.forEach(q);case"/update_operators":if("PUT"!==r.method)return s="/update_operators is a PUT request",console.error(s),new Response(s,{status:500});var l=await r.json();if(!p(_,l))return console.error("Invalid parameters",l),Response.error();l.forEach(e=>O(r.headers.get("Referrer"),e));default:var d="Unrecognised entrypoint "+u;return console.error(d),new Response(d,{status:404})}}catch(e){throw console.error(e),e}}export default P;export{r as isAddress,n as isTokenId,t as isTransfer,h as isTransfers,_ as isUpdateOperator,o as isBalanceRequest,w as isBalanceOf,e as isBalanceResponse,m as isMintNew};
